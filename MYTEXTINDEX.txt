<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, getDocs, serverTimestamp, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ✅ Your Real Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDd8nNkIdX1JYqFErFLkU76JGZHOBtIYP8",
        authDomain: "ganesha-yakshagana-mulleriya.firebaseapp.com",
        projectId: "ganesha-yakshagana-mulleriya",
        storageBucket: "ganesha-yakshagana-mulleriya.firebasestorage.app",
        messagingSenderId: "265173933005",
        appId: "1:265173933005:web:7f5d61f53293ea34180284",
        measurementId: "G-96N96PV1QE"
    };

    let db, auth;
    let userId = 'anonymous';

    const ADMIN_WHATSAPP_NUMBER = '919148014768';

    // ✅ Initialize Firebase
    const initializeFirebase = async () => {
        const loadingMessage = document.getElementById('loading-message');
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            await new Promise((resolve, reject) => {
                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    unsubscribe();
                    if (user) {
                        userId = user.uid;
                        resolve();
                    } else {
                        await signInAnonymously(auth);
                        userId = auth.currentUser.uid;
                        resolve();
                    }
                }, reject);
            });

            window.db = db;
            window.auth = auth;
            window.userId = userId;

            console.log("✅ Firebase connected successfully. User ID:", userId);

            loadDynamicContent();
        } catch (error) {
            console.error("❌ Firebase Initialization Failed:", error);
            loadingMessage.innerHTML = `
                <p class="text-red-500 font-bold">
                    ಡೇಟಾಬೇಸ್ ಸಂಪರ್ಕ ವಿಫಲವಾಯಿತು. ಫೈರ್‌ಬೇಸ್ ಕಾನ್ಫಿಗರೇಶನ್ ಅಥವಾ ನಿಯಮಗಳನ್ನು ಪರಿಶೀಲಿಸಿ.
                </p>
                <p class="text-sm text-gray-600 mt-2">(${error.message})</p>`;
        }
    };

    // ✅ Collection Path Helper
    const getCollectionPath = (collectionName) => collectionName;

    // ✅ Load Live Data from Firestore
    const loadDynamicContent = () => {
        onSnapshot(collection(db, getCollectionPath('events')), (snapshot) => {
            const events = [];
            snapshot.forEach(doc => events.push({ id: doc.id, ...doc.data() }));
            renderEvents(events);
        });

        onSnapshot(collection(db, getCollectionPath('students')), (snapshot) => {
            const students = [];
            snapshot.forEach(doc => students.push({ id: doc.id, ...doc.data() }));
            renderStudents(students);
        });

        onSnapshot(collection(db, getCollectionPath('gallery')), (snapshot) => {
            const galleryItems = [];
            snapshot.forEach(doc => galleryItems.push({ id: doc.id, ...doc.data() }));
            renderGallery(galleryItems);
        });

        onSnapshot(doc(db, getCollectionPath('donations'), 'total'), (docSnapshot) => {
            const totalDonation = docSnapshot.exists() ? docSnapshot.data().amount : 0;
            renderDonationTotal(totalDonation);
        });

        onSnapshot(doc(db, getCollectionPath('donations'), 'qr'), (docSnapshot) => {
            const qrUrl = docSnapshot.exists() && docSnapshot.data().url ? docSnapshot.data().url : "https://placehold.co/200x200/4c4d51/FFFFFF?text=QR+Code+Unavailable";
            document.getElementById('qr-code-img').src = qrUrl;
        });

        onSnapshot(doc(db, getCollectionPath('guru'), 'details'), (docSnapshot) => {
            if (docSnapshot.exists()) {
                const guruData = {
                    name: docSnapshot.data().name || "ಗುರುಗಳ ಹೆಸರು ಲಭ್ಯವಿಲ್ಲ",
                    photoUrl: docSnapshot.data().photoUrl || 'https://placehold.co/150x150/8b5cf6/FFFFFF?text=ಗುರು+ಭಾವಚಿತ್ರ'
                };
                renderGuru(guruData);
            }
        });

        document.getElementById('loading-message').style.display = 'none';
    };

    window.onload = initializeFirebase;
</script>
